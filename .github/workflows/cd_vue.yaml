name: CD - Deploy to Server

on:
  workflow_run:
    workflows: ['CI - Build & Push']
    types:
      - completed
    branches: [main]
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: polaris-frontend
  CONTAINER_NAME: polaris-frontend

jobs:
  deploy:
    name: 무중단 배포
    runs-on: ubuntu-22.04
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: 배포 시작 알림
        run: |
          echo "### Starting Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ secrets.OCIR_REGISTRY }}/${{ secrets.OCIR_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY

      - name: SSH로 서버 배포 (무중단)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            echo "========================================="
            echo "무중단 배포 시작"
            echo "========================================="

            # 변수 설정
            REGISTRY="${{ secrets.OCIR_REGISTRY }}"
            NAMESPACE="${{ secrets.OCIR_NAMESPACE }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            NEW_CONTAINER="${CONTAINER_NAME}-new"
            IMAGE="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:latest"

            # 필요시 네트워크 생성
            docker network create npm_network || true

            # OCIR 로그인
            echo "1. OCIR 로그인 중..."
            echo "${{ secrets.OCIR_TOKEN }}" | docker login ${REGISTRY} -u "${{ secrets.OCIR_USERNAME }}" --password-stdin

            # 최신 이미지 pull
            echo "2. 최신 이미지 다운로드 중..."
            docker pull ${IMAGE}

            # 기존 임시 컨테이너 정리 (이전 배포 실패 시 남아있을 수 있음)
            echo "3. 기존 임시 컨테이너 정리 중..."
            if docker ps -a --format '{{.Names}}' | grep -q "^${NEW_CONTAINER}$"; then
              echo "   기존 임시 컨테이너 발견 - 제거 중..."
              docker stop ${NEW_CONTAINER} || true
              docker rm ${NEW_CONTAINER} || true
            else
              echo "   기존 임시 컨테이너 없음"
            fi

            # 새 컨테이너 실행 (임시 이름, 외부 포트 공개 포함)
            echo "4. 새 컨테이너 실행 중... (이름: ${NEW_CONTAINER})"
            docker run -d \
              --name ${NEW_CONTAINER} \
              --network npm_network \
              -p 8080:80 \
              --restart unless-stopped \
              ${IMAGE}

            # Health check - 새 컨테이너가 준비될 때까지 대기
            echo "4. Health check 중..."
            for i in {1..30}; do
              if docker exec ${NEW_CONTAINER} wget --quiet --tries=1 --spider http://localhost/ 2>/dev/null; then
                echo "   ✓ 새 컨테이너 정상 동작 확인 (${i}초 경과)"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "   ✗ Health check 실패 - 롤백 시작"
                docker stop ${NEW_CONTAINER}
                docker rm ${NEW_CONTAINER}
                exit 1
              fi
              echo "   대기 중... (${i}/30)"
              sleep 1
            done

            # 기존 컨테이너 확인 및 중지
            echo "5. 기존 컨테이너 처리 중..."
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "   기존 컨테이너 중지 중..."
              docker stop ${CONTAINER_NAME} || true
              echo "   기존 컨테이너 삭제 중..."
              docker rm ${CONTAINER_NAME} || true
            else
              echo "   기존 컨테이너 없음 (최초 배포)"
            fi

            # 새 컨테이너 이름 변경
            echo "6. 새 컨테이너 활성화 중..."
            docker rename ${NEW_CONTAINER} ${CONTAINER_NAME}

            # 미사용 이미지 정리
            echo "7. 미사용 이미지 정리 중..."
            docker image prune -af

            echo "========================================="
            echo "무중단 배포 완료"
            echo "========================================="

            # 배포 정보 출력
            echo ""
            echo "컨테이너 정보:"
            docker ps --filter name=${CONTAINER_NAME} --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: 배포 완료 알림
        if: success()
        run: |
          echo "### Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "무중단 배포가 성공적으로 완료되었습니다." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**배포 전략:** Blue-Green 방식 무중단 배포" >> $GITHUB_STEP_SUMMARY
          echo "- 새 컨테이너 실행 → Health Check → 이전 컨테이너 중지 → 전환" >> $GITHUB_STEP_SUMMARY

      - name: 배포 실패 알림
        if: failure()
        run: |
          echo "### Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "배포 중 오류가 발생했습니다." >> $GITHUB_STEP_SUMMARY
          echo "기존 컨테이너는 계속 실행 중입니다. (무중단 보장)" >> $GITHUB_STEP_SUMMARY
