<script setup lang="ts">
import { computed, onMounted, watch } from 'vue'
import { useAnalysis } from '@/composables/useAnalysis'
import { Loader2, AlertTriangle } from 'lucide-vue-next'

const props = defineProps<{
  siteId: string
}>()

const { vulnerability, loading, error, fetchVulnerability } = useAnalysis(props.siteId)

// 데이터 로드
onMounted(async () => {
  await fetchVulnerability()
})

// siteId 변경 시 데이터 재로드
watch(
  () => props.siteId,
  async () => {
    await fetchVulnerability()
  }
)

const vulnerabilityFactors = computed(() => vulnerability.value?.factors || [])

const totalVulnerabilityScore = computed(
  () => vulnerability.value?.overallVulnerability || 0
)

const vulnerabilityLevel = computed(() => vulnerability.value?.vulnerabilityLevel || 'LOW')

const maxScore = 100

const getLevelColor = (score: number) => {
  if (score >= 70) return '#EA002C'
  if (score >= 50) return '#F47725'
  if (score >= 30) return '#FBBC05'
  return '#B3CF0A'
}

const getLevelBgColor = (score: number) => {
  if (score >= 70) return '#FEE2E2'
  if (score >= 50) return '#FED7AA'
  if (score >= 30) return '#FEF3C7'
  return '#ECFCCB'
}

const getVulnerabilityLevelLabel = (level: string) => {
  switch (level) {
    case 'CRITICAL':
      return '매우 높음'
    case 'HIGH':
      return '높음'
    case 'MODERATE':
      return '보통'
    case 'LOW':
      return '낮음'
    default:
      return level
  }
}
</script>

<template>
  <div class="mt-6">
    <!-- 로딩 상태 -->
    <div v-if="loading" class="flex items-center justify-center py-20">
      <Loader2 class="animate-spin text-[#EA002C]" :size="40" />
      <span class="ml-3 text-gray-600">취약성 분석 데이터를 불러오는 중...</span>
    </div>

    <!-- 에러 상태 -->
    <div v-else-if="error" class="flex flex-col items-center justify-center py-20">
      <AlertTriangle class="text-red-600 mb-4" :size="48" />
      <p class="text-gray-900 font-medium mb-2">데이터를 불러오는데 실패했습니다</p>
      <p class="text-sm text-gray-600">{{ error.message }}</p>
    </div>

    <!-- 빈 상태 -->
    <div
      v-else-if="!vulnerability || vulnerabilityFactors.length === 0"
      class="flex flex-col items-center justify-center py-20"
    >
      <AlertTriangle class="text-gray-400 mb-4" :size="48" />
      <p class="text-gray-900 font-medium mb-2">취약성 분석 결과가 없습니다</p>
      <p class="text-sm text-gray-600">해당 사업장에 대한 취약성 분석을 먼저 실행해주세요.</p>
    </div>

    <!-- 데이터가 있을 때 -->
    <div v-else>
      <!-- 종합 취약성 점수 -->
      <div class="bg-white border border-gray-200 shadow-sm mb-6">
        <div class="border-b border-gray-200 px-6 py-3 bg-gray-50">
          <h3 class="text-sm text-gray-900">종합 취약성 점수</h3>
        </div>
        <div class="p-8 flex items-center justify-between">
          <div class="text-sm text-gray-600 flex flex-col gap-2">
            <div>점수가 높을수록 기후 리스크 취약성이 높습니다</div>
            <div class="font-medium">
              취약성 수준: <span :style="{ color: getLevelColor(totalVulnerabilityScore) }">
                {{ getVulnerabilityLevelLabel(vulnerabilityLevel) }}
              </span>
            </div>
          </div>
          <div class="flex items-center">
            <div class="flex items-baseline gap-2">
              <span class="text-4xl text-[#EA002C]">{{ totalVulnerabilityScore }}</span>
              <span class="text-2xl text-gray-400">/ {{ maxScore }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 취약성 요인별 분석 -->
      <div class="bg-white border border-gray-200 shadow-sm">
        <div class="border-b border-gray-200 px-6 py-3 bg-gray-50">
          <h3 class="text-sm text-gray-900">취약성 요인별 분석</h3>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <div
              v-for="(factor, index) in vulnerabilityFactors"
              :key="index"
              class="border-b border-gray-100 pb-4 last:border-b-0 last:pb-0"
            >
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                  <div class="text-sm text-gray-900 w-32">{{ factor.factor }}</div>
                </div>
                <div
                  class="px-3 py-1 text-xs"
                  :style="{
                    color: getLevelColor(factor.score),
                    backgroundColor: getLevelBgColor(factor.score)
                  }"
                >
                  {{ factor.score }}점
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex-1 bg-gray-100 h-2 overflow-hidden">
                  <div
                    class="h-full transition-all duration-500"
                    :style="{
                      width: `${factor.score}%`,
                      backgroundColor: getLevelColor(factor.score)
                    }"
                  ></div>
                </div>
                <div class="text-xs text-gray-500 w-12 text-right">{{ factor.score }}%</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
